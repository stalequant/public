<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Coin Data Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: black;
            color: white;
        }
        #chart-container {
            width: 80%;
            height: 80vh;
            position: relative;
        }
        #watermark {
            position: absolute;
            top: 90%;
            left: 50%;
            font-size: 48px;
            opacity: 0.1;
            pointer-events: none;
        }
        #custom-legend {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 25px;
            cursor: pointer;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        .legend-text {
            color: white;

        }
    </style>
</head>
<body>
    <h1 id="chartTitle">Dynamic Coin Data Chart</h1>
    <div id="chart-container">
        <div id="watermark">stalequant.github.io/public/</div>
        <canvas id="coinChart"></canvas>
    </div>
    <div id="custom-legend"></div>

    <script>
        // Get the coin from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
	const defaultCoins = ['BTC', 'ETH', 'TRX','XRP','DOGE','LINK','BCH','AVAX','MATIC','SOL', 'ADA', 'INJ'];

	// Get the coin from URL parameters or choose a random one from the list
	const coin = urlParams.get('coin') || defaultCoins[Math.floor(Math.random() * defaultCoins.length)];

        document.getElementById('chartTitle').textContent = `${coin} orderbooks and trades. Choose a coin by appending &coin=${coin} to the URL`;

        const ctx = document.getElementById('coinChart').getContext('2d');
        const coinChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: `HL Trades`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        backgroundColor: 'hsl(172,47%,51%)',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 5, 
                        fill: false,
                        showLine: false
                    },
                    {
                        label: `HL Bid`,
                        data: [],
                        backgroundColor: 'hsla(172,47%,51%,0.2)',
                        borderWidth: 0,
                        fill: '+1',
                        stepped: true,
		        hidden: true,  // Start hidden

                        pointRadius: 0
                    },
                    {
                        label: `HL Ask`,
                        data: [],
                        backgroundColor: 'hsla(172,47%,51%,0.2)',
                        borderWidth: 0,
                        fill: '-1',
		        hidden: true,  // Start hidden
                        stepped: true,
                        pointRadius: 0,
                        display: false
                    },
                    {
                        label: `HL $5000 depth bid`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        borderWidth: 2,
                        fill: false,
                        
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: `HL $5000 depth ask`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        borderWidth: 2,
                        fill: false,
                        
                        stepped: true,
                        pointRadius: 0,
                        display: false
                    },
                    {
                        label: 'Binance Trades',
                        data: [],
                        borderColor: '#FCD535',
                        backgroundColor: '#FCD535',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        
                        fill: false,
                        showLine: false
                    },
                    {
                        label: 'Binance Bid',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.2)',
                        borderWidth: 0,
                        fill: '+1',
		        hidden: true,  // Start hidden
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Ask',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.2)',
                        borderWidth: 0,
                        fill: '-1',
                        stepped: true,
		        hidden: true,  // Start hidden
                        pointRadius: 0,
                        display: false
                    },
                    {
                        label: 'Binance $5000 Bid',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
                        
                        fill: false,
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance $5000 Ask',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
                        
                        stepped: true,
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot Trades',
                        data: [],
                        borderColor: '#FC0535',
                        backgroundColor: '#FC0535',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        
                        fill: false,
                        showLine: false
                    },
                    {
                        label: 'Binance Spot Bid',
                        data: [],
                        backgroundColor: 'rgba(252, 05, 53, 0.2)',
                        borderWidth: 0,
		        hidden: true,  // Start hidden
                        fill: '+1',
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot Ask',
                        data: [],
                        backgroundColor: 'rgba(252, 05, 53, 0.2)',
                        borderWidth: 0,
                        fill: '-1',
		        hidden: true,  // Start hidden
                        stepped: true,
                        pointRadius: 0,
                        display: false
                    },
                    {
                        label: 'Binance Spot $5000 Bid',
                        data: [],
                        borderColor: '#FC0535',
                        borderWidth: 2,
                        fill: false,
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot  $5000 Ask',
                        data: [],
                        borderColor: '#FC0535',
                        borderWidth: 2,
                        stepped: true,
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        grid: {
                            display: false,
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            display: false,
                            color: 'white'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        enabled: false
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Custom legend
        const legendItems = [
            { text: 'Hyperliquid', color: 'hsl(172,47%,51%)', style: 'square', datasets: [0, 1, 2, 3, 4] },
            { text: 'Binance', color: '#FCD535', style: 'square', datasets: [5, 6, 7, 8, 9] },
            { text: 'Binance Spot', color: '#FC0535', style: 'square', datasets: [10, 11, 12, 13, 14] },
            { text: 'Trades', color: 'white', pointStyle: 'circle', datasets: [0, 5, 10] },
            { text: 'Spread at $5000', color: 'white', style: 'line', datasets: [3, 4, 8, 9, 13, 14] },
            { text: 'Bid-Ask', color: 'rgba(255,255,255,0.5)', style: 'square', datasets: [1, 2, 6,7, 11, 12] }
        ];

        const legendContainer = document.getElementById('custom-legend');
        legendItems.forEach((item, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            
            const color = document.createElement('div');
            color.className = 'legend-color';
            color.style.backgroundColor = item.color;
            if (item.style === 'line') {
                color.style.height = '2px';
                color.style.marginTop = '4px';
                color.style.marginBottom = '4px';
            } else if (item.style === 'circle') {
                color.style.borderRadius = '50%';
            }
            
            const text = document.createElement('span');
            text.className = 'legend-text';
            text.textContent = item.text;
            
            legendItem.appendChild(color);
            legendItem.appendChild(text);
            legendContainer.appendChild(legendItem);
            
    legendItem.onclick = function() {
        item.datasets.forEach(datasetIndex => {
                const meta = coinChart.getDatasetMeta(datasetIndex);
                meta.hidden = !meta.hidden;
        });
	coinChart.update();
    };
});

        const dataWindow = 30000; // 30 seconds of data
        let lastUpdateTime = Date.now();

        const wsHyperliquid = new WebSocket('wss://api.hyperliquid.xyz/ws');
        const wsBinanceBookTicker = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@depth20@100ms`);
        const wsBinanceAggTrade = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@aggTrade`);
        const wsBinanceSpotBookTicker = new WebSocket(`wss://stream.binance.com:443/ws/${coin.toLowerCase()}usdt@depth20@100ms`);
        const wsBinanceSpotAggTrade = new WebSocket(`wss://stream.binance.com:443/ws/${coin.toLowerCase()}usdt@aggTrade`);


        wsHyperliquid.onopen = function() {
            console.log('Hyperliquid WebSocket is connected');
            wsHyperliquid.send(JSON.stringify({
                "method": "subscribe",
                "subscription": { "type": "l2Book", "coin": coin }
            }));
            wsHyperliquid.send(JSON.stringify({
                "method": "subscribe",
                "subscription": { "type": "trades", "coin": coin }
            }));
        };

        wsHyperliquid.onmessage = function(event) {
            const message = JSON.parse(event.data);

            if (message.channel === "l2Book" && message.data.coin === coin) {
                const timestamp = parseFloat(message.data.time);
                const levels = message.data.levels;
		const reqLiq = 5000;
                if (levels && levels.length >= 2) {
                    const bid = parseFloat(levels[0][0].px);
                    const ask = parseFloat(levels[1][0].px);
                    let sum = 0;
                    let i = 0;
                    while (i < levels[0].length && sum < reqLiq) {
                        sum += parseFloat(levels[0][i].sz) * parseFloat(levels[0][i].px);
                        i++;
                    }
                    if (sum >= reqLiq) {
                        deepBid = parseFloat(levels[0][i-1].px);
                    } else if (levels[0].length > 0) {
                        deepBid = parseFloat(levels[0][levels[0].length - 1].px) / 1.01;
                    }
		    
                    let sumA = 0;
                    let iA = 0;
                    while (iA < levels[1].length && sumA < reqLiq) {
                        sumA += parseFloat(levels[1][iA].sz) * parseFloat(levels[1][i].px);
                        iA++;
                    }
                    if (sumA >= reqLiq) {
                        deepAsk = parseFloat(levels[1][iA-1].px);
                    } else if (levels[1].length > 0) {
                        deepAsk = parseFloat(levels[1][levels[1].length - 1].px) * 1.01;
                    }


                    addData(1, timestamp, bid);
                    addData(2, timestamp, ask);
                    addData(3, timestamp, deepBid);
                    addData(4, timestamp, deepAsk);
                }
            }

            if (message.channel === "trades" && message.data.length > 0) {
                message.data.forEach(trade => {
                    if (trade.coin === coin) {
                        const tradePrice = parseFloat(trade.px);
                        const timestamp = trade.time;
                        addData(0, timestamp, tradePrice);
                    }
                });
            }
        };

        wsHyperliquid.onerror = function(error) {
            console.error('Hyperliquid WebSocket Error: ', error);
        };

        wsHyperliquid.onclose = function() {
            console.log('Hyperliquid WebSocket is closed');
        };



        wsBinanceBookTicker.onopen = function() {
            console.log('Binance BookTicker WebSocket is connected');
        };

        wsBinanceBookTicker.onmessage = function(event) {
            const message = JSON.parse(event.data);

            if (message.e === "depthUpdate" && message.s === `${coin}USDT`) {	
		    const reqLiq = 5000;
                    const bid = parseFloat(message.b[0][0]);
                    const ask = parseFloat(message.a[0][0]);      
	            const timestamp = parseFloat(message.E);


                    let sum = 0;
                    let i = 0;
                    while (i < message.b.length && sum < reqLiq) {
                        sum += parseFloat(message.b[i][1]) * parseFloat(message.b[i][0]);
                        i++;
                    }
                    if (i <2 || sum >= reqLiq) {
                        deepBid = parseFloat(message.b[i-1][0]);
                    } else if (message.b.length > 0) {
                        deepBid = parseFloat(message.b[message.b.length - 1][0]) / 1.01;
                    }
		    
                    let sumA = 0;
                    let iA = 0;
                    while (iA < message.a.length && sumA < reqLiq) {
                        sumA += parseFloat(message.a[iA][1]) * parseFloat(message.a[iA][0]);
                        iA++;
                    }
                    if (iA <2 || sumA >= reqLiq) {
                        deepAsk = parseFloat(message.a[iA-1][0]);
                    } else if (message.a.length > 0) {
                        deepAsk = parseFloat(message.a[message.a.length - 1][0]) * 1.01;
                    }

                    addData(6, timestamp, bid); // Binance Bid
                    addData(7, timestamp, ask); // Binance Ask
                    addData(8, timestamp, deepBid); // Binance Bid
                    addData(9, timestamp, deepAsk); // Binance Ask


            }
        };

        wsBinanceAggTrade.onopen = function() {
            console.log('Binance AggTrade WebSocket is connected');
        };

        wsBinanceAggTrade.onmessage = function(event) {
            const message = JSON.parse(event.data);
            if (message.e === "aggTrade" && message.s === `${coin}USDT`) {
                const tradePrice = parseFloat(message.p);
                const timestamp = message.T;
                addData(5, timestamp, tradePrice); // Binance Trades
            }
        };

        wsBinanceBookTicker.onerror = function(error) {
            console.error('Binance BookTicker WebSocket Error: ', error);
        };

        wsBinanceBookTicker.onclose = function() {
            console.log('Binance BookTicker WebSocket is closed');
        };

        wsBinanceAggTrade.onerror = function(error) {
            console.error('Binance AggTrade WebSocket Error: ', error);
        };

        wsBinanceAggTrade.onclose = function() {
            console.log('Binance AggTrade WebSocket is closed');
        };





        wsBinanceSpotBookTicker.onopen = function() {
            console.log('BinanceSpot BookTicker WebSocket is connected');
        };

        wsBinanceSpotBookTicker.onmessage = function(event) {
            const message = JSON.parse(event.data);
            const currentTime = Date.now();
		    const reqLiq = 5000;
                    const bid = parseFloat(message.bids[0][0]);
                    const ask = parseFloat(message.asks[0][0]);      
	            const timestamp = parseFloat(message.E);


                    let sum = 0;
                    let i = 0;
                    while (i < message.bids.length && sum < reqLiq) {
                        sum += parseFloat(message.bids[i][1]) * parseFloat(message.bids[i][0]);
                        i++;
                    }
                    if (i <2 || sum >= reqLiq) {
                        deepBid = parseFloat(message.bids[i-1][0]);
                    } else if (message.bids.length > 0) {
                        deepBid = parseFloat(message.bids[message.bids.length - 1][0]) / 1.01;
                    }
		    
                    let sumA = 0;
                    let iA = 0;
                    while (iA < message.asks.length && sumA < reqLiq) {
                        sumA += parseFloat(message.asks[iA][1]) * parseFloat(message.asks[iA][0]);
                        iA++;
                    }
                    if (iA <2 || sumA >= reqLiq) {
                        deepAsk = parseFloat(message.asks[iA-1][0]);
                    } else if (message.asks.length > 0) {
                        deepAsk = parseFloat(message.asks[message.asks.length - 1][0]) * 1.01;
                    }

                    addData(11, currentTime, bid); // BinanceSpot Bid
                    addData(12, currentTime, ask); // BinanceSpot Ask
                    addData(13, currentTime, deepBid); // BinanceSpot Bid
                    addData(14, currentTime, deepAsk); // BinanceSpot Ask



        };

        wsBinanceSpotAggTrade.onopen = function() {
            console.log('BinanceSpot AggTrade WebSocket is connected');
        };

        wsBinanceSpotAggTrade.onmessage = function(event) {
            const message = JSON.parse(event.data);
            if (message.e === "aggTrade" && message.s === `${coin}USDT`) {
                const tradePrice = parseFloat(message.p);
                const timestamp = message.T;
                addData(10, timestamp, tradePrice); // BinanceSpot Trades
            }
        };

        wsBinanceSpotBookTicker.onerror = function(error) {
            console.error('BinanceSpot BookTicker WebSocket Error: ', error);
        };

        wsBinanceSpotBookTicker.onclose = function() {
            console.log('BinanceSpot BookTicker WebSocket is closed');
        };

        wsBinanceSpotAggTrade.onerror = function(error) {
            console.error('BinanceSpot AggTrade WebSocket Error: ', error);
        };

        wsBinanceSpotAggTrade.onclose = function() {
            console.log('BinanceSpot AggTrade WebSocket is closed');
        };










        function addData(datasetIndex, time, value) {
            coinChart.data.datasets[datasetIndex].data.push({x: time, y: value});
        }

        function updateChart(currentTime) {
            // Remove old data points
            coinChart.data.datasets.forEach(dataset => {
                dataset.data = dataset.data.filter(point => point.x > currentTime - dataWindow*1.5);
            });

            // Update x-axis range
            coinChart.options.scales.x.min = currentTime - dataWindow;
            coinChart.options.scales.x.max = currentTime;

            coinChart.update('none');
        }

        // Smooth scrolling update loop
        function smoothScroll() {
            const currentTime = Date.now();
            const elapsed = currentTime - lastUpdateTime;
            lastUpdateTime = currentTime;

            // Move all data points to the left
            coinChart.data.datasets.forEach(dataset => {
                dataset.data.forEach(point => {
                    point.x -= elapsed;
                });
            });

            updateChart(currentTime);
            requestAnimationFrame(smoothScroll);
        }

        smoothScroll(); // Start the smooth scrolling


    </script>
</body>
</html>
