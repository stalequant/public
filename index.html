<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Coin Data Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: black;
            color: white;
        }
        #chart-container {
            width: 80%;
            height: 80%;
        }
    </style>
</head>
<body>
    <h1 id="chartTitle">Dynamic Coin Data Chart</h1>
    <div id="chart-container">
        <canvas id="coinChart"></canvas>
    </div>

    <script>
        // Get the coin from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const coin = urlParams.get('coin') || 'BTC';
        document.getElementById('chartTitle').textContent = `${coin} Data Chart`;

        const ctx = document.getElementById('coinChart').getContext('2d');
        const coinChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: `HL Trades`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        backgroundColor: 'hsl(172,47%,51%)',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        fill: false,
                        showLine: false
                    },
                    {
                        label: `HL Bid-Ask`,
                        data: [],
                        backgroundColor: 'hsla(172,47%,51%,0.33)',
                        borderWidth: 0,
                        fill: '+1',
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: `HL Ask HIDE`,
                        data: [],
                        backgroundColor: 'hsla(172,47%,51%,0.33)',
                        borderWidth: 0,
                        fill: '-1',
                        stepped: true,
                        pointRadius: 0,
			display: false
                    },
                    {
                        label: `HL $1000 depth`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        borderWidth: 2,
                        fill: false,
			borderDash: [10,5],
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: `HL AskD HIDE`,
                        data: [],
                        borderColor: 'hsl(172,47%,51%)',
                        borderWidth: 2,
                        fill: false,
			borderDash: [10,5],
                        stepped: true,
                        pointRadius: 0,
			display: false
                    },
                    {
                        label: 'Binance Trades',
                        data: [],
                        borderColor: '#FCD535',
                        backgroundColor: '#FCD535',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        fill: false,
                        showLine: false
                    },
                    {
                        label: 'Binance Bid-Ask',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.25)',
                        borderWidth: 0,
                        fill: '+1',
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Ask HIDE',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.25)',
                        borderWidth: 0,
                        fill: '-1',
                        stepped: true,
                        pointRadius: 0,
			display: false
                    },
                    {
                        label: 'Binance $1000 Depth',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
			borderDash: [10,5],
                        fill: false,
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance AskD HIDE',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
			borderDash: [10,5],
                        stepped: true,
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot Trades',
                        data: [],
                        borderColor: '#FCD535',
                        backgroundColor: '#FCD535',
                        borderWidth: 0,
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        fill: false,
                        showLine: false
                    },
                    {
                        label: 'Binance Spot Bid-Ask',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.25)',
                        borderWidth: 0,
                        fill: '+1',
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot Ask HIDE',
                        data: [],
                        backgroundColor: 'rgba(252, 213, 53, 0.25)',
                        borderWidth: 0,
                        fill: '-1',
                        stepped: true,
                        pointRadius: 0,
			display: false
                    },
                    {
                        label: 'Binance Spot $1000 Depth',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
			borderDash: [10,5],
                        fill: false,
                        stepped: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Binance Spot AskD HIDE',
                        data: [],
                        borderColor: '#FCD535',
                        borderWidth: 2,
			borderDash: [10,5],
                        stepped: true,
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        grid: {
                            display: false,
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            display: false,
                            color: 'white'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        labels: {
                            color: 'white',
                            filter: function(item, chart) {
                                // Return false to hide the legend item
                                return !item.text.includes('HIDE');
                            }
                        }
                    }
                }
            }
        });

        const wsHyperliquid = new WebSocket('wss://api.hyperliquid.xyz/ws');
        const wsBinanceBookTicker = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@depth20@100ms`);
        const wsBinanceAggTrade = new WebSocket(`wss://fstream.binance.com/ws/${coin.toLowerCase()}usdt@aggTrade`);
        const wsBinanceSpotBookTicker = new WebSocket(`wss://stream.binance.com/ws/${coin.toUpperCase()}USDT@depth20@100ms`);
        const wsBinanceSpotAggTrade = new WebSocket(`wss://stream.binance.com/ws/${coin.toUpperCase()}USDT@aggTrade`);
        const dataWindow = 30000; // 30 seconds of data
        let lastUpdateTime = Date.now();

        wsHyperliquid.onopen = function() {
            console.log('Hyperliquid WebSocket is connected');
            wsHyperliquid.send(JSON.stringify({
                "method": "subscribe",
                "subscription": { "type": "l2Book", "coin": coin }
            }));
            wsHyperliquid.send(JSON.stringify({
                "method": "subscribe",
                "subscription": { "type": "trades", "coin": coin }
            }));
        };

        wsHyperliquid.onmessage = function(event) {
            const message = JSON.parse(event.data);

            if (message.channel === "l2Book" && message.data.coin === coin) {
                const timestamp = parseFloat(message.data.time);
                const levels = message.data.levels;
		const reqLiq = 5000;
                if (levels && levels.length >= 2) {
                    const bid = parseFloat(levels[0][0].px);
                    const ask = parseFloat(levels[1][0].px);
		    console.log(message.data);
                    let sum = 0;
                    let i = 0;
                    while (i < levels[0].length && sum < reqLiq) {
                        sum += parseFloat(levels[0][i].sz) * parseFloat(levels[0][i].px);
                        i++;
                    }
                    if (sum >= reqLiq) {
                        deepBid = parseFloat(levels[0][i-1].px);
                    } else if (levels[0].length > 0) {
                        deepBid = parseFloat(levels[0][levels[0].length - 1].px) / 1.01;
                    }
		    
                    let sumA = 0;
                    let iA = 0;
                    while (iA < levels[1].length && sumA < reqLiq) {
                        sumA += parseFloat(levels[1][iA].sz) * parseFloat(levels[1][i].px);
                        iA++;
                    }
                    if (sumA >= reqLiq) {
                        deepAsk = parseFloat(levels[1][iA-1].px);
                    } else if (levels[1].length > 0) {
                        deepAsk = parseFloat(levels[1][levels[1].length - 1].px) * 1.01;
                    }


                    addData(1, timestamp, bid);
                    addData(2, timestamp, ask);
                    addData(3, timestamp, deepBid);
                    addData(4, timestamp, deepAsk);
                }
            }

            if (message.channel === "trades" && message.data.length > 0) {
                message.data.forEach(trade => {
                    if (trade.coin === coin) {
                        const tradePrice = parseFloat(trade.px);
                        const timestamp = trade.time;
                        addData(0, timestamp, tradePrice);
                    }
                });
            }
        };

        wsBinanceBookTicker.onopen = function() {
            console.log('Binance BookTicker WebSocket is connected');
        };

        wsBinanceBookTicker.onmessage = function(event) {
            const message = JSON.parse(event.data);

            if (message.e === "depthUpdate" && message.s === `${coin}USDT`) {	
		    const reqLiq = 5000;
                    const bid = parseFloat(message.b[0][0]);
                    const ask = parseFloat(message.a[0][0]);      
	            const timestamp = parseFloat(message.E);


                    let sum = 0;
                    let i = 0;
                    while (i < message.b.length && sum < reqLiq) {
                        sum += parseFloat(message.b[i][1]) * parseFloat(message.b[i][0]);
                        i++;
                    }
                    if (i <2 || sum >= reqLiq) {
                        deepBid = parseFloat(message.b[i-1][0]);
                    } else if (message.b.length > 0) {
                        deepBid = parseFloat(message.b[message.b.length - 1][0]) / 1.01;
                    }
		    
                    let sumA = 0;
                    let iA = 0;
                    while (iA < message.a.length && sumA < reqLiq) {
                        sumA += parseFloat(message.a[iA][1]) * parseFloat(message.a[iA][0]);
                        iA++;
                    }
                    if (iA <2 || sumA >= reqLiq) {
                        deepAsk = parseFloat(message.a[iA-1][0]);
                    } else if (message.a.length > 0) {
                        deepAsk = parseFloat(message.a[message.a.length - 1][0]) * 1.01;
                    }

                    addData(6, timestamp, bid); // Binance Bid
                    addData(7, timestamp, ask); // Binance Ask
                    addData(8, timestamp, deepBid); // Binance Bid
                    addData(9, timestamp, deepAsk); // Binance Ask


            }
        };

        wsBinanceAggTrade.onopen = function() {
            console.log('Binance AggTrade WebSocket is connected');
        };

        wsBinanceAggTrade.onmessage = function(event) {
            const message = JSON.parse(event.data);
            if (message.e === "aggTrade" && message.s === `${coin}USDT`) {
                const tradePrice = parseFloat(message.p);
                const timestamp = message.T;
                addData(5, timestamp, tradePrice); // Binance Trades
            }
        };

        function addData(datasetIndex, time, value) {
            coinChart.data.datasets[datasetIndex].data.push({x: time, y: value});
        }

        function updateChart(currentTime) {
            // Remove old data points
            coinChart.data.datasets.forEach(dataset => {
                dataset.data = dataset.data.filter(point => point.x > currentTime - dataWindow*1.5);
            });

            // Update x-axis range
            coinChart.options.scales.x.min = currentTime - dataWindow;
            coinChart.options.scales.x.max = currentTime;

            coinChart.update('none');
        }

        // Smooth scrolling update loop
        function smoothScroll() {
            const currentTime = Date.now();
            const elapsed = currentTime - lastUpdateTime;
            lastUpdateTime = currentTime;

            // Move all data points to the left
            coinChart.data.datasets.forEach(dataset => {
                dataset.data.forEach(point => {
                    point.x -= elapsed;
                });
            });

            updateChart(currentTime);
            requestAnimationFrame(smoothScroll);
        }

        smoothScroll(); // Start the smooth scrolling

        wsHyperliquid.onerror = function(error) {
            console.error('Hyperliquid WebSocket Error: ', error);
        };

        wsHyperliquid.onclose = function() {
            console.log('Hyperliquid WebSocket is closed');
        };

        wsBinanceBookTicker.onerror = function(error) {
            console.error('Binance BookTicker WebSocket Error: ', error);
        };

        wsBinanceBookTicker.onclose = function() {
            console.log('Binance BookTicker WebSocket is closed');
        };

        wsBinanceAggTrade.onerror = function(error) {
            console.error('Binance AggTrade WebSocket Error: ', error);
        };

        wsBinanceAggTrade.onclose = function() {
            console.log('Binance AggTrade WebSocket is closed');
        };
    </script>
</body>
</html>
